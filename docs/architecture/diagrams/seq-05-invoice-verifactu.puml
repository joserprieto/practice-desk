@startuml seq-05-invoice-verifactu
!include brand-palette.puml
title Invoice Generation with VeriFactu (Facturacion)

actor "Paralegal\n(Auxiliar Juridico)" as Paralegal
participant "Frontend" as FE
participant "API" as API
participant "InvoiceService" as IS
participant "AEAT\n(VeriFactu)" as AEAT
database "Database" as DB

== 1. Select Time Entries & Expenses ==

Paralegal -> FE : Open expediente\n& click "Generar Factura"
activate FE

FE -> API : GET /api/expedientes/{id}/time-entries\n?invoiceId=null&billable=true
activate API
API -> DB : SELECT time_entries\nWHERE expedienteId = ?\nAND invoiceId IS NULL\nAND billable = true
activate DB
DB --> API : Unbilled time entries
deactivate DB
API --> FE : 200 OK — time entries
deactivate API

FE -> API : GET /api/expedientes/{id}/expenses\n?invoiceId=null
activate API
API -> DB : SELECT expenses\nWHERE expedienteId = ?\nAND invoiceId IS NULL
activate DB
DB --> API : Unbilled expenses\n(suplidos: tasas judiciales,\ngastos notariales, etc.)
deactivate DB
API --> FE : 200 OK — expenses
deactivate API

FE --> Paralegal : Show billable items:\n- Time entries with hours & rates\n- Suplidos (third-party expenses)
deactivate FE

Paralegal -> FE : Select entries to invoice\n& choose invoice type:\n"Nota de Honorarios"
activate FE

== 2. Calculate Invoice Amounts ==

FE -> API : POST /api/invoices/preview\n{ expedienteId,\n  type: 'fee_note',\n  timeEntryIds: [...],\n  expenseIds: [...] }
activate API

API -> IS : calculateInvoice(data)
activate IS

note right of IS
  **Calculation rules for fee_note:**

  1. Honorarios (professional fees):
     Sum of (hours x hourlyRate)
     for each time entry.

  2. IVA (21%):
     Applied to honorarios only.

  3. IRPF (-15%):
     Retention on honorarios
     (withheld by client, paid to AEAT).

  4. Suplidos (third-party expenses):
     NO IVA applied.
     Passed through at cost.
end note

IS -> IS : Calculate honorarios:\nEntry 1: 3.5h x 150 EUR = 525.00\nEntry 2: 2.0h x 150 EUR = 300.00\nEntry 3: 1.5h x 150 EUR = 225.00\n——————————————\nBase imponible = 1,050.00 EUR

IS -> IS : Calculate taxes:\nIVA 21%:  +220.50 EUR\nIRPF 15%: -157.50 EUR

IS -> IS : Calculate suplidos:\nTasa judicial:   250.00 EUR\nGastos notariales: 85.00 EUR\n——————————————\nTotal suplidos = 335.00 EUR\n(exempt from IVA)

IS -> IS : Calculate total:\nHonorarios:    1,050.00\n+ IVA 21%:      +220.50\n- IRPF 15%:     -157.50\n+ Suplidos:     +335.00\n——————————————————\nTOTAL:         1,448.00 EUR

IS --> API : Invoice preview:\n{ taxableBase: 1050.00,\n  vatRate: 0.21,\n  vatAmount: 220.50,\n  irpfRate: 0.15,\n  irpfAmount: 157.50,\n  suplidos: 335.00,\n  totalAmount: 1448.00 }
deactivate IS

API --> FE : 200 OK — invoice preview
deactivate API

FE --> Paralegal : Show invoice preview:\n\nHonorarios:     1,050.00 EUR\nIVA (21%):       +220.50 EUR\nIRPF (15%):      -157.50 EUR\nSuplidos:        +335.00 EUR\n————————————————————\nTOTAL:          1,448.00 EUR
deactivate FE

== 3. Generate Sequential Invoice Number ==

Paralegal -> FE : Confirm & click\n"Emitir Factura"
activate FE

FE -> API : POST /api/invoices\n{ expedienteId, type: 'fee_note',\n  timeEntryIds, expenseIds,\n  concept: 'Honorarios profesionales\n  por servicios juridicos\n  expediente 2026/0042' }
activate API

API -> IS : generateInvoice(data)
activate IS

IS -> DB : SELECT MAX(invoice_number)\nFROM invoices\nWHERE firmId = ?\nAND YEAR(issue_date) = 2026\nFOR UPDATE
activate DB
DB --> IS : Last number: "2026/0087"
deactivate DB

IS -> IS : Next sequential number:\n"2026/0088"

note right of IS
  **VeriFactu compliance:**
  - Sequential numbering
    with no gaps allowed.
  - Invoice number format:
    YYYY/NNNN
  - Must include QR code
    linking to AEAT verification.
end note

== 4. Generate VeriFactu QR & Submit to AEAT ==

IS -> IS : Generate VeriFactu\ninvoice XML:\n- Firm NIF/CIF\n- Client NIF/CIF\n- Invoice number\n- Issue date\n- Taxable base\n- VAT rate & amount\n- IRPF rate & amount\n- Total amount
IS -> IS : Calculate hash chain:\nhash = SHA-256(\n  previousInvoiceHash\n  + invoiceData)

IS -> AEAT : POST /verifactu/invoices\n{ invoiceXML, hash,\n  previousHash }
activate AEAT

alt #CLAY_100 AEAT Rejects Submission
    AEAT --> IS : 422 Validation Error\n"NIF del cliente no valido"
    IS --> API : Error: AEAT rejection
    API --> FE : 422 Error:\n"Error VeriFactu:\nNIF del cliente no valido"
    FE --> Paralegal : Show error:\n"No se pudo registrar\nen VeriFactu.\nVerifique el NIF del cliente."

else #FERN_100 AEAT Accepts Submission
    AEAT --> IS : 200 OK\n{ registrationId,\n  qrCodeUrl,\n  verificationUrl }
    deactivate AEAT

    IS -> IS : Generate QR code\nencoding verificationUrl

    == 5. Save Invoice & Mark Time Entries ==

    IS -> DB : BEGIN TRANSACTION
    activate DB

    IS -> DB : INSERT invoice\n(firmId, clientId, expedienteId,\ninvoiceNumber='2026/0088',\ntype='fee_note',\nissueDate=NOW(),\nconcept='...',\ntaxableBase=1050.00,\nvatRate=0.21, vatAmount=220.50,\nirpfRate=0.15, irpfAmount=157.50,\ntotalAmount=1448.00,\npaymentStatus='unpaid',\nverifactuQr='{qrData}')
    DB --> IS : Invoice saved (id)

    IS -> DB : UPDATE time_entries\nSET invoiceId = ?\nWHERE id IN (...)
    DB --> IS : Time entries linked

    IS -> DB : UPDATE expenses\nSET invoiceId = ?\nWHERE id IN (...)
    DB --> IS : Expenses linked

    IS -> DB : COMMIT
    DB --> IS : Transaction committed
    deactivate DB

    IS --> API : Invoice created:\n{ id, invoiceNumber: '2026/0088',\n  verifactuQr, totalAmount }
    deactivate IS

    API --> FE : 201 Created
    deactivate API

    FE --> Paralegal : Invoice generated:\n"Factura 2026/0088\nTotal: 1,448.00 EUR\nRegistrada en VeriFactu"
    deactivate FE

end

== 6. Track Payment Status ==

...time passes...

Paralegal -> FE : Open invoice\n& record payment
activate FE

alt Partial payment received
    Paralegal -> FE : Record partial payment:\n800.00 EUR received
    FE -> API : PATCH /api/invoices/{id}\n{ paymentStatus: 'partial',\n  amountReceived: 800.00 }
    activate API
    API -> DB : UPDATE invoice\nSET paymentStatus = 'partial'
    activate DB
    DB --> API : Updated
    deactivate DB
    API --> FE : 200 OK
    deactivate API
    FE --> Paralegal : Status: "Pago parcial\n800.00 / 1,448.00 EUR"

else Full payment received
    Paralegal -> FE : Record full payment
    FE -> API : PATCH /api/invoices/{id}\n{ paymentStatus: 'paid',\n  paidAt: NOW() }
    activate API
    API -> DB : UPDATE invoice\nSET paymentStatus = 'paid',\npaidAt = NOW()
    activate DB
    DB --> API : Updated
    deactivate DB
    API --> FE : 200 OK
    deactivate API
    FE --> Paralegal : Status: "Pagada"

else Payment overdue (30+ days)
    API -> API : Scheduled check:\ninvoice unpaid > 30 days
    API -> DB : UPDATE invoice\nSET paymentStatus = 'overdue'
    activate DB
    DB --> API : Updated
    deactivate DB
    API --> Paralegal : Alert: "Factura 2026/0088\nvencida. Impago > 30 dias."
    note right of Paralegal
      Options: send reminder,
      initiate jura de cuentas
      (expedited fee collection).
    end note
end

deactivate FE

@enduml
