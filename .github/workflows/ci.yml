# ====================================================================================
# CI Workflow - Practice Desk
# ====================================================================================
#
# Runs linting checks on every push to main and on pull requests.
# On main-branch failures, automatically creates GitHub issues.
# On main-branch success, automatically closes any open CI failure issues.
#
# Security note: No user-controllable inputs are interpolated into run: commands.
# All GitHub context values used are safe (github.ref, github.server_url,
# github.repository, github.run_id, needs.*.result).
#
# ====================================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Lint Markdown
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  lint-markdown:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: '**/*.md'
          fix: false

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Lint Shell Scripts
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  lint-shell:
    name: Shell Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: '.github/scripts'
          severity: warning

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Format Check
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npx prettier --check '**/*.{md,json,yml,yaml}'

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Lint API Specs
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  lint-api:
    name: API Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Lint OpenAPI
        run: npx @redocly/cli lint docs/architecture/api/openapi.yaml --format=github-actions

      - name: Validate AsyncAPI
        run: npx @asyncapi/cli validate docs/architecture/api/asyncapi.yaml

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # CI Summary
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [lint-markdown, lint-shell, format-check, lint-api]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Make scripts executable
        run:
          chmod +x .github/scripts/ci/*.sh .github/scripts/issues/*.sh
          .github/scripts/issues/lib/*.sh

      - name: Determine overall result
        id: result
        env:
          LINT_MD_RESULT: ${{ needs.lint-markdown.result }}
          LINT_SHELL_RESULT: ${{ needs.lint-shell.result }}
          FORMAT_RESULT: ${{ needs.format-check.result }}
          LINT_API_RESULT: ${{ needs.lint-api.result }}
        run: |
          echo "lint-markdown=${LINT_MD_RESULT}" >> "$GITHUB_OUTPUT"
          echo "lint-shell=${LINT_SHELL_RESULT}" >> "$GITHUB_OUTPUT"
          echo "format-check=${FORMAT_RESULT}" >> "$GITHUB_OUTPUT"
          echo "lint-api=${LINT_API_RESULT}" >> "$GITHUB_OUTPUT"

          if [[ "${LINT_MD_RESULT}" == "success" && \
                "${LINT_SHELL_RESULT}" == "success" && \
                "${FORMAT_RESULT}" == "success" && \
                "${LINT_API_RESULT}" == "success" ]]; then
            echo "overall=success" >> "$GITHUB_OUTPUT"
          else
            echo "overall=failure" >> "$GITHUB_OUTPUT"
          fi

      - name: Print summary
        env:
          LINT_MD_RESULT: ${{ needs.lint-markdown.result }}
          LINT_SHELL_RESULT: ${{ needs.lint-shell.result }}
          FORMAT_RESULT: ${{ needs.format-check.result }}
          LINT_API_RESULT: ${{ needs.lint-api.result }}
          OVERALL_RESULT: ${{ steps.result.outputs.overall }}
        run: |
          echo "## CI Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Job | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Markdown Lint | \`${LINT_MD_RESULT}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Shell Lint | \`${LINT_SHELL_RESULT}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Format Check | \`${FORMAT_RESULT}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| API Lint | \`${LINT_API_RESULT}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [[ "${OVERALL_RESULT}" == "success" ]]; then
            echo "**Overall: All checks passed.**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "**Overall: One or more checks failed.**" >> "$GITHUB_STEP_SUMMARY"
          fi

      # --- Failure handling (main branch only) ---

      - name: Handle lint-markdown failure
        if: >-
          always() && github.ref == 'refs/heads/main' && needs.lint-markdown.result == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: .github/scripts/ci/on-failure.sh "lint-markdown" "${RUN_URL}"

      - name: Handle lint-shell failure
        if: >-
          always() && github.ref == 'refs/heads/main' && needs.lint-shell.result == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: .github/scripts/ci/on-failure.sh "lint-shell" "${RUN_URL}"

      - name: Handle format-check failure
        if: >-
          always() && github.ref == 'refs/heads/main' && needs.format-check.result == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: .github/scripts/ci/on-failure.sh "format-check" "${RUN_URL}"

      - name: Handle lint-api failure
        if: >-
          always() && github.ref == 'refs/heads/main' && needs.lint-api.result == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: .github/scripts/ci/on-failure.sh "lint-api" "${RUN_URL}"

      # --- Success handling (main branch only) ---

      - name: Handle lint-markdown success
        if: >-
          always() && github.ref == 'refs/heads/main' && needs.lint-markdown.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/ci/on-success.sh "lint-markdown"

      - name: Handle lint-shell success
        if: >-
          always() && github.ref == 'refs/heads/main' && needs.lint-shell.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/ci/on-success.sh "lint-shell"

      - name: Handle format-check success
        if: >-
          always() && github.ref == 'refs/heads/main' && needs.format-check.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/ci/on-success.sh "format-check"

      - name: Handle lint-api success
        if: >-
          always() && github.ref == 'refs/heads/main' && needs.lint-api.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/ci/on-success.sh "lint-api"

      # --- Final gate ---

      - name: Fail if any job failed
        if: always() && steps.result.outputs.overall == 'failure'
        run: |
          echo "::error::CI failed. See individual job results above."
          exit 1
